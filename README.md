# Deployment Project Guide

Two-node Docker deployment for the Game System with HTTPS reverse proxy.

- **Admin Node**: Backend API, Order/Chat/Monitor Services, Admin Panel, DCC Tools, PostgreSQL, Redis
- **Game Node**: GameHub Server, Game Client (Plinko), PostgreSQL, Redis

## Architecture

```
┌─────────────────────────────────────┐     ┌─────────────────────────────────────┐
│         Admin Node (:443)           │     │         Game Node (:443)            │
│                                     │     │                                     │
│  nginx (HTTPS)                      │     │  nginx (HTTPS)                      │
│    /manager, /agent  → static SPA   │     │    /          → game client static  │
│    /api/*            → backend:9986 │     │    /ws        → gamehub:10101 (WS)  │
│    /channel/*        → backend:9986 │     │    /gamehub/* → gamehub:9643 (API)  │
│    /chatservice.*    → chat:8896    │     │                                     │
│    /monitor/*        → monitor:17782│     │  postgres ─── gamehub               │
│    /dcctools/*       → dcctools:8080│     │  redis   ─┘                         │
│                                     │     └─────────────────────────────────────┘
│  postgres ─── backend               │
│         \     orderservice           │
│  redis ──┘    chatservice            │
│               monitorservice         │
│               dcctools + mysql       │
└─────────────────────────────────────┘
```

**Only ports 80 (redirect) and 443 (HTTPS) are exposed on each node.** All inter-node communication goes through nginx HTTPS proxy.

## Services

| Service | Node | Internal Port | Description |
|---------|------|--------------|-------------|
| backend | Admin | 9986 | Platform API, channel handler |
| orderservice | Admin | 9988 | Order/record processing |
| chatservice | Admin | 8896 | Chat WebSocket + API |
| monitorservice | Admin | 17782, 17783 | Monitor WebSocket + API |
| dcctools | Admin | 8080 | Testing tool (同花順) |
| gamehub | Game | 9643, 10101, 10201 | Game server (HTTP, WS, TCP) |
| game-client | Game | 443 | Plinko game client (nginx) |

## Directory Structure

```
deployment-project/
├── setup.sh                    # [Step 1] Generate all configs
├── squash_db.sh                # [Step 2] Clean DB migrations (optional)
├── gcloud_firewall.sh          # [Step 3] Firewall helper
├── build/                      # Dockerfiles (shared)
│   ├── Dockerfile.backend
│   ├── Dockerfile.frontend
│   ├── Dockerfile.gamehub
│   ├── Dockerfile.orderservice
│   ├── Dockerfile.chatservice
│   ├── Dockerfile.monitorservice
│   └── Dockerfile.dcctools
├── admin-node/                 # Deploy to Admin Server
│   ├── docker-compose.yml
│   ├── .env                    # Generated by setup.sh
│   ├── certs/                  # SSL certificates
│   ├── configs/
│   │   ├── nginx.conf          # HTTPS reverse proxy
│   │   ├── config.yml          # Backend (generated)
│   │   ├── orderservice.yml    # OrderService (generated)
│   │   ├── chatservice.yml     # ChatService (generated)
│   │   └── monitorservice.yml  # MonitorService (generated)
│   ├── db-init/                # PostgreSQL + MySQL init
│   │   ├── clean_init.sql      # From squash_db.sh
│   │   ├── init-extra-dbs.sql  # Creates dcc_order, dcc_chat, monitor
│   │   ├── dcctools-schema.sql # MySQL schema (copied by setup.sh)
│   │   └── dcctools-init.sql   # MySQL data fixes
│   └── scripts/
│       ├── update_server_info.sql  # Generated by setup.sh
│       └── update_game_data.sql    # Generated by setup.sh
└── game-node/                  # Deploy to Game Server
    ├── docker-compose.yml
    ├── .env                    # Generated by setup.sh
    ├── certs/                  # SSL certificates
    ├── configs/
    │   ├── GameHub.conf        # Generated by setup.sh
    │   ├── game-client-nginx.conf   # HTTPS + WS proxy
    │   └── game-client-config.json  # Generated by setup.sh
    ├── db-init/                # Game SQL init (copied by setup.sh)
    │   ├── gamelist.sql
    │   ├── gameinfo.sql
    │   └── lobbyinfo.sql
    └── client-dist/            # Game client static files
```

## Quick Start

### 1. Generate Configs

```bash
cd deployment-project
bash setup.sh
# Enter: Admin IP, Game IP, DB password, Redis password, SSL cert path
# Leave SSL empty for self-signed certificates
```

### 2. Clean Database (Recommended)

```bash
bash squash_db.sh
# Creates admin-node/db-init/clean_init.sql (consolidates 300+ migrations)
```

### 3. Prepare Game Client

Copy Plinko build output to `game-node/client-dist/`:
```bash
cp -r ../遊戲客戶端/plinko/outsource/build/* game-node/client-dist/
```

### 4. Upload to Servers

Since Docker images require full source code to build, upload the **entire project root**:
```bash
# Upload to both servers
scp -r ../  admin-server:/opt/deploy/
scp -r ../  game-server:/opt/deploy/
```

### 5. Deploy (Order Matters!)

**Game Node FIRST** (Backend needs GameHub to be running):
```bash
# On Game Server
cd /opt/deploy/deployment-project/game-node
docker compose up -d --build
# Wait for gamehub to be healthy
docker compose ps
```

**Then Admin Node**:
```bash
# On Admin Server
cd /opt/deploy/deployment-project/admin-node
docker compose up -d --build
# Backend will: run migrations → fix DB → wait for GameHub → start
```

### 6. Verify

```bash
# Game Node
curl -k https://<GAME_IP>/                  # Game client
curl -k https://<GAME_IP>/gamehub/ping      # GameHub API

# Admin Node
curl -k https://<ADMIN_IP>/manager          # Admin panel
curl -k https://<ADMIN_IP>/api/v1/health/health  # Backend API
```

**Browser verification**:
1. Open `https://<ADMIN_IP>/manager` (login: `dccuser` / `12345678`)
2. Confirm left sidebar loads fully (no white screen)
3. Confirm chatService connects (no JS throw → white screen)
4. Test DCC Tools at `https://<ADMIN_IP>/dcctools/`
5. Enter a game → play → check order records

## Security

- **Only ports 80/443 exposed** on each node (all traffic via nginx HTTPS proxy)
- **Database and Redis** are internal-only (Docker network)
- **SSH tunneling** for remote DB admin: `ssh -L 5432:localhost:5432 user@server`
- Backend entrypoint sets agent `ip_whitelist` to `*` — restrict for production

## Firewall

```bash
bash gcloud_firewall.sh
# Both nodes only need: tcp:80,tcp:443
```

## Troubleshooting

| Problem | Solution |
|---------|----------|
| Backend won't start | Check `docker compose logs backend`. It needs GameHub to be running (healthcheck wait loop). |
| White screen after login | ChatService not running or server_info `chat` entry has wrong domain/scheme. Check `docker compose logs chatservice`. |
| "Game is close" | Game SQL init files missing. Check `docker compose logs -f postgres` on Game Node for init errors. |
| Game client blank page | Static assets getting SPA fallback. Check `game-client-nginx.conf` has static file rules. |
| channelHandle 403 | Agent `api_ip_whitelist` not set. Backend entrypoint should fix this automatically. Restart backend if agent cache is stale. |
| Admin login blocked | Agent `ip_whitelist` not set. Same fix as above. |
| GameHub "SettlePlatform" error | GameHub.conf `SettlePlatform.DEV` must point to `https://<ADMIN_IP>/` (via nginx proxy to backend). |
| Self-signed cert errors | Use `curl -k` for testing. Browser will show warning — click through. |

## Common Commands

```bash
# View logs
docker compose logs -f backend
docker compose logs -f gamehub

# Rebuild after code changes
docker compose up -d --build

# Restart a service (agent cache refresh)
docker compose restart backend

# Check health
docker compose ps

# DB access via SSH tunnel
ssh -L 5432:localhost:5432 user@admin-server
psql -h localhost -U postgres -d dcc_game
```

## Local Testing

Use `docker-compose.local.yml` for local integration testing (all services on one machine):
```bash
cd deployment-project
docker compose -f docker-compose.local.yml up --build
# Access: http://localhost/manager
```
