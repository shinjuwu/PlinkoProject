services:
  # ─── Database ───
  postgres:
    image: postgres:14-alpine
    container_name: admin-postgres
    restart: always
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: dcc_game
      TZ: "UTC"
    volumes:
      - pg_data:/var/lib/postgresql/data
      # clean_init.sql is optional (from squash_db.sh). If absent, backend runs migrations.
      # Uncomment after running squash_db.sh:
      # - ./db-init/clean_init.sql:/docker-entrypoint-initdb.d/00_clean_init.sql
      - ./db-init/init-extra-dbs.sql:/docker-entrypoint-initdb.d/01_init-extra-dbs.sql
      # NOTE: update_server_info.sql and update_game_data.sql are NOT mounted here.
      # These tables are created by backend migrations (not during postgres init).
      # The backend entrypoint handles these updates after the first migration run.
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - admin_net

  # ─── Redis ───
  redis:
    image: redis:alpine
    container_name: admin-redis
    restart: always
    command: redis-server --requirepass ${REDIS_PASSWORD}
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - admin_net

  # ─── Backend API ───
  backend:
    build:
      context: ../../
      dockerfile: deployment-project/build/Dockerfile.backend
    container_name: admin-backend
    restart: always
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    entrypoint: ["/bin/sh", "/app/entrypoint.sh"]
    environment:
      - TZ=UTC
      - DB_HOST=postgres
      - DB_PASSWORD=${POSTGRES_PASSWORD}
      # Cross-node: use GCP internal IP + HTTP (avoids self-signed cert TLS issues)
      # Replace GAME_INTERNAL_IP with game-node's VPC internal IP (e.g. 10.140.0.5)
      - GAMEHUB_URL=http://${GAME_INTERNAL_IP:-${GAME_NODE_IP}}:9643
      - ADMIN_HOST=${ADMIN_NODE_IP}
      - GAME_CLIENT_BASE=https://${GAME_NODE_IP}
      - SERVICE_SCHEME=https
    volumes:
      - ./configs/config.yml:/app/config.yml:ro
    ports:
      - "9986:9986"
    networks:
      - admin_net

  # ─── Order Service ───
  orderservice:
    build:
      context: ../../
      dockerfile: deployment-project/build/Dockerfile.orderservice
    container_name: orderservice
    restart: always
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      - TZ=UTC
    volumes:
      - ./configs/orderservice.yml:/app/config.yml:ro
    networks:
      - admin_net

  # ─── Chat Service ───
  chatservice:
    build:
      context: ../../
      dockerfile: deployment-project/build/Dockerfile.chatservice
    container_name: chatservice
    restart: always
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      - TZ=UTC
    volumes:
      - ./configs/chatservice.yml:/app/config.yml:ro
    networks:
      - admin_net

  # ─── Monitor Service ───
  monitorservice:
    build:
      context: ../../
      dockerfile: deployment-project/build/Dockerfile.monitorservice
    container_name: monitorservice
    restart: always
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      - TZ=UTC
    volumes:
      - ./configs/monitorservice.yml:/app/config.yml:ro
    networks:
      - admin_net

  # ─── DCC Tools MySQL ───
  dcctools-mysql:
    image: mysql:8.0
    container_name: dcctools-mysql
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-RootPass123!}
      MYSQL_DATABASE: dcc
      MYSQL_USER: dccuser
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-Dcc@12345}
    command: --default-authentication-plugin=mysql_native_password --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
    volumes:
      - dcctools_mysql_data:/var/lib/mysql
      - ./db-init/dcctools-schema.sql:/docker-entrypoint-initdb.d/01-schema.sql:ro
      - ./db-init/dcctools-init.sql:/docker-entrypoint-initdb.d/02-init.sql:ro
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD:-RootPass123!}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - admin_net

  # ─── DCC Tools (同花順測試工具) ───
  dcctools:
    build:
      context: ../../
      dockerfile: deployment-project/build/Dockerfile.dcctools
    container_name: dcctools
    restart: always
    depends_on:
      dcctools-mysql:
        condition: service_healthy
      orderservice:
        condition: service_started
    networks:
      - admin_net

  # ─── Frontend (nginx reverse proxy + static) ───
  frontend:
    build:
      context: ../../
      dockerfile: deployment-project/build/Dockerfile.frontend
    container_name: admin-frontend
    restart: always
    depends_on:
      - backend
    volumes:
      - ./configs/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ./certs:/etc/nginx/certs:ro
    ports:
      - "80:80"
      - "443:443"
    networks:
      - admin_net

volumes:
  pg_data:
  dcctools_mysql_data:

networks:
  admin_net:
    driver: bridge
